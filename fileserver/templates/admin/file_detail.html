{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Datei verwalten</h2>
  <p>
    <strong>Titel:</strong> {{ file.title }}<br>
    <strong>UUID:</strong> <code>{{ file.id }}</code><br>
    <strong>MIME:</strong> {{ file.mime_type }} ¬∑
    <strong>Gr√∂√üe:</strong> {{ file.size_bytes }} Bytes<br>
    <a href="{{ url_for('admin.index') }}">‚Üê Zur√ºck zur Liste</a>
  </p>
</section>

<section class="card">
  <h3>Vorschau (ohne Token)</h3>
  <div id="preview" style="margin:.5rem 0;"></div>
  <button id="loadPreview">Vorschau laden</button>
  <small style="color:#666;display:block;margin-top:.5rem;">Streamt direkt aus dem Storage (Admin-intern).</small>
</section>

<section class="card">
  <h3>Metadaten bearbeiten</h3>
  <form method="post" action="{{ url_for('admin.file_update', file_id=file.id) }}">
    <div class="row">
      <input name="title" value="{{ file.title }}" required>
      <input name="year" type="number" min="0" value="{{ file.year or '' }}" placeholder="Jahr (optional)">
    </div>
    <button type="submit">Speichern</button>
  </form>
</section>

<section class="card">
  <h3>Einbettung (√∂ffentlich, ben√∂tigt Token)</h3>
  <div class="row" style="grid-template-columns:160px 1fr;display:grid;gap:.5rem 1rem;align-items:center;">
    <label>Base URL</label>
    <input id="base" value="{{ request.url_root.rstrip('/') }}">
    <label>UUID</label>
    <input id="uuid" value="{{ file.id }}" readonly>
    <label>Token</label>
    <input id="token" placeholder="Token einf√ºgen ‚Ä¶">
    <label>Typ</label>
    <select id="kind">
      {% for k in kinds %}
        <option value="{{ k }}" {% if k==default_kind %}selected{% endif %}>{{ k }}</option>
      {% endfor %}
    </select>
  </div>
  <button id="build" style="margin-top:.6rem;">Snippet erzeugen</button>

  <h4 style="margin-top:1rem;">Fertiger Link</h4>
  <p>
    <code id="link">‚Äì</code>
    <button id="copyLink" style="margin-left:.5rem;">Kopieren</button>
  </p>

  <h4>HTML-Snippet</h4>
  <pre id="snippet" style="white-space: pre-wrap; background: #f8f8f8; padding: .75rem; border-radius: 8px;">‚Äì</pre>
  <button id="copySnippet">Snippet kopieren</button>
</section>

<section class="card" style="border-color:#f3b;box-shadow:0 1px 2px rgba(255,0,128,.08)">
  <h3>üóëÔ∏è L√∂schen</h3>
  <form method="post" action="{{ url_for('admin.file_delete', file_id=file.id) }}" onsubmit="return confirm('Diese Datei und ihr Ordner werden dauerhaft gel√∂scht. Fortfahren?')">
    <button type="submit" style="background:#c33">Datei endg√ºltig l√∂schen</button>
  </form>
</section>

<script>
  const $ = (s) => document.querySelector(s);
  const previewKind = "{{ default_kind }}";
  const previewSrc  = '{{ url_for("admin.admin_stream", file_id=file.id) }}';

  const el = {
    preview: $('#preview'),
    base: $('#base'),
    uuid: $('#uuid'),
    token: $('#token'),
    kind: $('#kind'),
    link: $('#link'),
    snippet: $('#snippet'),
    build: $('#build'),
    copyLink: $('#copyLink'),
    copySnippet: $('#copySnippet'),
    loadPreview: $('#loadPreview')
  };

  function htmlFor(kind, src) {
    if (kind === 'video') return `<video controls preload="metadata" width="640" src="${src}"></video>`;
    if (kind === 'audio') return `<audio controls preload="metadata" src="${src}"></audio>`;
    if (kind === 'image') return `<img src="${src}" alt="" style="max-width:100%;height:auto;">`;
    if (kind === 'pdf')   return `<iframe src="${src}" width="100%" height="600" style="border:1px solid #eee;border-radius:8px;"></iframe>`;
    return `<a href="${src}" target="_blank" rel="noopener">Datei √∂ffnen</a>`;
  }

  // Admin-Preview (ohne Token)
  el.loadPreview.addEventListener('click', () => {
    el.preview.innerHTML = htmlFor(previewKind, previewSrc);
  });

  // Embed-Snippet builder
  function build() {
    const base  = el.base.value.trim().replace(/\/+$/,'');
    const uuid  = el.uuid.value.trim();
    const token = el.token.value.trim();
    const kind  = el.kind.value;
    if (!base || !uuid || !token) { alert('Bitte Base, UUID und Token angeben.'); return; }
    const src = `${base}/api/embed/${encodeURIComponent(uuid)}?token=${encodeURIComponent(token)}`;
    el.link.textContent = src;
    el.snippet.textContent = htmlFor(kind, src);
  }

  function copyText(text, btn) {
    navigator.clipboard?.writeText(text).then(() => {
      const old = btn.textContent;
      btn.textContent = 'Kopiert';
      setTimeout(() => btn.textContent = old, 1100);
    }).catch(() => alert('Kopieren nicht m√∂glich'));
  }

  el.build.addEventListener('click', build);
  el.copyLink.addEventListener('click', (e) => copyText(el.link.textContent, e.currentTarget));
  el.copySnippet.addEventListener('click', (e) => copyText(el.snippet.textContent, e.currentTarget));
</script>
{% endblock %}
